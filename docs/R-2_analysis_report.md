# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è R-2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–º-–ª–∏–¥–∞

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 2025-05-23  
**–°—Ç–∞—Ç—É—Å**: üü° –ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ R-2 –∏–º–µ–µ—Ç **—á–∞—Å—Ç–∏—á–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é** –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, API –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞, –Ω–æ **–æ—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê**.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (30% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

### 1. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ

- [x] –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ `docs/specs/R-2.md`
- [x] –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–∏—Å–∞–Ω—ã (happy path, –æ—à–∏–±–∫–∏, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∏–º-–ª–∏–¥—ã)
- [x] –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PlantUML
- [x] API –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ Swagger

### 2. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö ‚úÖ (—á–∞—Å—Ç–∏—á–Ω–æ)

- [x] `LimitRequest.CurrentApproverID` –ø–æ–ª–µ —Å–æ–∑–¥–∞–Ω–æ
- [x] `User` –º–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –¥–ª—è `DepartmentID`
- [x] `ApprovalStep` –∏ `AuditLog` –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
- [x] –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

### 3. Handler –∏ API ‚úÖ (—á–∞—Å—Ç–∏—á–Ω–æ)

- [x] Handler –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ "with R-2 auto team lead assignment"
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –æ—à–∏–±–∫–∏ R-2
- [x] –í–æ–∑–≤—Ä–∞—Ç `current_assignee_id` –≤ API –æ—Ç–≤–µ—Ç–µ
- [x] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `PENDING_TEAM_LEAD`

## ‚ùå –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (70% —Ä–∞–±–æ—Ç—ã)

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚ùå

```sql
-- –û–¢–°–£–¢–°–¢–í–£–ï–¢: department_id –≤ —Ç–∞–±–ª–∏—Ü–µ users
ALTER TABLE users ADD COLUMN department_id uuid REFERENCES departments(id);
```

### 2. –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚ùå

```go
// –í storage/limit_request_store.go PLACEHOLDER:
func (s *DBStore) FindTeamLeadByDepartment(ctx context.Context, departmentID uuid.UUID) (*models.User, error) {
    return nil, fmt.Errorf("department functionality not yet implemented")
}

// –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:
// 1. –ü–æ–∏—Å–∫ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// 2. –ü–æ–∏—Å–∫ —Ç–∏–º-–ª–∏–¥–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
// 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–∏–º-–ª–∏–¥–æ–≤ (ORDER BY email)
// 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CurrentApproverID –≤ –∑–∞—è–≤–∫–µ
```

### 3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å ‚ùå

```go
// –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –≤ Create method:
// 1. BEGIN TRANSACTION
// 2. INSERT INTO limit_requests
// 3. INSERT INTO approval_steps (step_type='TEAM_LEAD', status='PENDING')
// 4. INSERT INTO audit_log (action='request_created')
// 5. COMMIT TRANSACTION
```

### 4. –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ ‚ùå

- –¢–æ–ª—å–∫–æ placeholder —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
- –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
- –ù–ï–¢ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ R-2

## üîß –ü–ª–∞–Ω –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
-- database/migrations/003_add_department_support.sql
ALTER TABLE users ADD COLUMN department_id uuid;
```

### –®–∞–≥ 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è FindTeamLeadByDepartment

```go
func (s *DBStore) FindTeamLeadByDepartment(ctx context.Context, departmentID uuid.UUID) (*models.User, error) {
    query := `
        SELECT id, external_id, email, name, role, department_id, created_at, updated_at
        FROM users
        WHERE role = 'TEAM_LEAD' AND department_id = $1
        ORDER BY email ASC
        LIMIT 1`
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è...
}
```

### –®–∞–≥ 3: –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ Create

```go
func (s *DBStore) Create(ctx context.Context, request *models.LimitRequest) (*models.LimitRequest, error) {
    // 1. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç
    user, err := s.GetUserByID(ctx, request.UserID)
    // 2. –ù–∞–π—Ç–∏ —Ç–∏–º-–ª–∏–¥–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
    teamLead, err := s.FindTeamLeadByDepartment(ctx, user.DepartmentID)
    // 3. –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    tx, err := s.db.BeginTx(ctx, nil)
    // 4. –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º —Ç–∏–º-–ª–∏–¥–æ–º
    // 5. –°–æ–∑–¥–∞—Ç—å approval_step
    // 6. –°–æ–∑–¥–∞—Ç—å audit_log
    // 7. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
}
```

### –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```go
func TestR2_Integration_HappyPath(t *testing.T) {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–º
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–º-–ª–∏–¥–∞ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
    // –í—ã–∑–æ–≤ Create
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
}
```

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç R-2** - –∑–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–∏–º-–ª–∏–¥–∞
2. **–ù–ï–¢ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏** - –≤–æ–∑–º–æ–∂–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö
3. **–ù–ï–¢ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ R-2

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç            | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ            |
| -------------------- | ---------- | --------------------- |
| –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è         | 100%       | ‚úÖ –ü–æ–ª–Ω–∞—è             |
| API –∫–æ–Ω—Ç—Ä–∞–∫—Ç         | 100%       | ‚úÖ Swagger –≥–æ—Ç–æ–≤      |
| –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö        | 80%        | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î  |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞        | 10%        | ‚ùå –¢–æ–ª—å–∫–æ placeholder |
| –¢–µ—Å—Ç—ã                | 20%        | ‚ùå –¢–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞   |
| **–û–ë–©–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨** | **30%**    | üü° –ß–∞—Å—Ç–∏—á–Ω–æ           |

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è R-2

1. **–í–´–°–û–ö–ò–ô**: –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è department_id
2. **–í–´–°–û–ö–ò–ô**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å FindTeamLeadByDepartment
3. **–í–´–°–û–ö–ò–ô**: –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –≤ Create
4. **–°–†–ï–î–ù–ò–ô**: –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
5. **–ù–ò–ó–ö–ò–ô**: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üîç –í—ã–≤–æ–¥—ã

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ R-2 –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–∞–¥–∏–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –•–æ—Ç—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—Å–Ω–æ–≤–∞ –∑–∞–ª–æ–∂–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, **–æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**. –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –µ—â–µ ~70% —Ä–∞–±–æ—Ç—ã, –≤–∫–ª—é—á–∞—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ —Ç–µ—Å—Ç—ã.
